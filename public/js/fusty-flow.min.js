/* * MIT Licensed * http://github.com/flowjs/fusty-flow.js * Aidas Klimas */function fustyFlowFactory(a){var b=new Flow(a);return b.support?b:new FustyFlow(a)}!function(a,b,c){"use strict";function d(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c}function e(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent?a.detachEvent("on"+b,c):a["on"+b]=null}function f(a){a.parentNode.removeChild(a)}function g(a){var b={};return a&&"[object Function]"===b.toString.call(a)}function h(b){this.support=!1,this.files=[],this.events=[],this.defaults={simultaneousUploads:3,fileParameterName:"file",query:{},target:"/",generateUniqueIdentifier:null,matchJSON:!1};var c=this;this.inputChangeEvent=function(a){var b=a.srcElement;e(b,"change",c.inputChangeEvent);var f=b.cloneNode(!1);b.parentNode.replaceChild(f,b),c.addFile(b,a),f.value="",d(f,"change",c.inputChangeEvent)},this.opts=a.extend({},this.defaults,b||{})}function i(a,b){this.flowObj=a,this.element=b,this.name=b.value&&b.value.replace(/.*(\/|\\)/,""),this.relativePath=this.name,this.uniqueIdentifier=a.generateUniqueIdentifier(b),this.iFrame=null,this.finished=!1,this.error=!1;var c=this;this.iFrameLoaded=function(){if(c.iFrame&&c.iFrame.parentNode){c.finished=!0;try{if(c.iFrame.contentDocument&&c.iFrame.contentDocument.body&&"false"==c.iFrame.contentDocument.body.innerHTML)return}catch(a){return c.error=!0,c.abort(),void c.flowObj.fire("fileError",c,a)}var b=c.iFrame.contentDocument||c.iFrame.contentWindow.document,d=b.body.innerHTML;c.flowObj.opts.matchJSON&&(d=/(\{.*\})/.exec(d)[0]),c.abort(),c.flowObj.fire("fileSuccess",c,d),c.flowObj.upload()}},this.bootstrap()}var j=a.extend,k=a.each;h.prototype={on:a.prototype.on,fire:a.prototype.fire,cancel:a.prototype.cancel,assignBrowse:function(a){"undefined"==typeof a.length&&(a=[a]),k(a,function(a){var b;"INPUT"===a.tagName&&"file"===a.type?b=a:(b=c.createElement("input"),b.setAttribute("type","file"),j(a.style,{display:"inline-block",position:"relative",overflow:"hidden",verticalAlign:"top"}),j(b.style,{position:"absolute",top:0,right:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,opacity:0,filter:"alpha(opacity=0)",cursor:"pointer"}),a.appendChild(b)),d(b,"change",this.inputChangeEvent)},this)},assignDrop:function(){},unAssignDrop:function(){},isUploading:function(){var a=!1;return k(this.files,function(b){return b.isUploading()?(a=!0,!1):void 0}),a},upload:function(){var a=0;k(this.files,function(b){if(1!=b.progress()){if(b.isUploading())return void a++;if(a++>=this.opts.simultaneousUploads)return!1;1==a&&this.fire("uploadStart"),b.send()}},this),a||this.fire("complete")},pause:function(){k(this.files,function(a){a.abort()})},resume:function(){this.upload()},progress:function(){var a=0,b=0;return k(this.files,function(c){a+=c.progress(),b++}),b>0?a/b:0},addFiles:function(a,b){var c=[];k(a,function(a){if(1===a.nodeType&&a.value){var d=new i(this,a);this.fire("fileAdded",d,b)&&c.push(d)}},this),this.fire("filesAdded",c,b)&&k(c,function(a){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(a)},this),this.fire("filesSubmitted",c,b)},addFile:function(a,b){this.addFiles([a],b)},generateUniqueIdentifier:function(a){var b=this.opts.generateUniqueIdentifier;return"function"==typeof b?b(a):"xxxxxxxx-xxxx-yxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},getFromUniqueIdentifier:function(a){var b=!1;return k(this.files,function(c){c.uniqueIdentifier==a&&(b=c)}),b},removeFile:function(a){for(var b=this.files.length-1;b>=0;b--)this.files[b]===a&&this.files.splice(b,1)},getSize:function(){},timeRemaining:function(){},sizeUploaded:function(){}},i.prototype={getExtension:a.FlowFile.prototype.getExtension,getType:function(){},send:function(){if(!this.finished){var a=this.flowObj.opts,b=this.createForm(),c=a.query;g(c)&&(c=c(this)),c[a.fileParameterName]=this.element,c.flowFilename=this.name,c.flowRelativePath=this.relativePath,c.flowIdentifier=this.uniqueIdentifier,this.addFormParams(b,c),d(this.iFrame,"load",this.iFrameLoaded),b.submit(),f(b)}},abort:function(a){this.iFrame&&(this.iFrame.setAttribute("src","java"+String.fromCharCode(115)+"cript:false;"),f(this.iFrame),this.iFrame=null,!a&&this.flowObj.upload())},cancel:function(){this.flowObj.removeFile(this),this.abort()},retry:function(){this.bootstrap(),this.flowObj.upload()},bootstrap:function(){this.abort(!0),this.finished=!1,this.error=!1},timeRemaining:function(){},sizeUploaded:function(){},resume:function(){this.flowObj.upload()},pause:function(){this.abort()},isUploading:function(){return null!==this.iFrame},isComplete:function(){return 1===this.progress()},progress:function(){return this.error?1:this.finished?1:0},createIframe:function(){var a=c.createElement(/MSIE (6|7|8)/.test(navigator.userAgent)?'<iframe name="'+this.uniqueIdentifier+'_iframe">':"iframe");return a.setAttribute("id",this.uniqueIdentifier+"_iframe_id"),a.setAttribute("name",this.uniqueIdentifier+"_iframe"),a.style.display="none",c.body.appendChild(a),a},createForm:function(){var a=this.flowObj.opts.target,b=c.createElement("form");return b.encoding="multipart/form-data",b.method="POST",b.setAttribute("action",a),this.iFrame||(this.iFrame=this.createIframe()),b.setAttribute("target",this.iFrame.name),b.style.display="none",c.body.appendChild(b),b},addFormParams:function(a,b){var d;k(b,function(b,e){b&&1===b.nodeType?d=b:(d=c.createElement("input"),d.setAttribute("value",b)),d.setAttribute("name",e),a.appendChild(d)})}},h.FustyFlowFile=i,"undefined"!=typeof module?module.exports=h:"function"==typeof define&&define.amd?define(function(){return h}):b.FustyFlow=h}(window.Flow,window,document);